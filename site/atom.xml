<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Paul Smith</title>
  <subtitle>Programmer, co-founder of EveryBlock</subtitle>
  <link href="http://pauladamsmith.com/atom.xml" rel="self" />
  <link href="http://pauladamsmith.com/" />
  <id>pauladamsmith.com</id>
  <updated>2012-08-07T04:20:00Z</updated>
  <author>
    <name>Paul Smith</name>
    <email>paulsmith@pobox.com</email>
  </author>
  <entry>
    <title>The Election Day Advent Calendar</title>
    <link href="/blog/2012/08/the-election-day-advent-calendar.html" />
    <id>http://pauladamsmith.com/blog/2012/08/the-election-day-advent-calendar.html</id>
    <updated>2012-08-07T04:20:00Z</updated>
    <content type="html">&lt;p style=&#34;float: right; margin: 0 0 10px 10px&#34;&gt;&lt;a href=&#34;http://www.kickstarter.com/projects/electioncalendar/the-election-day-advent-calendar&#34; title=&#34;The Kickstarter for the Election Day Advent Calendar&#34;&gt;&lt;img src=&#34;/images/edac2012.jpg&#34; alt=&#34;The Election Day Advent Calendar&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My friend Ben Helphand and I started scheming in 2005 on a way to
celebrate the right to vote. We believed that a great nation deserves
great civic rituals, and the election season was the natural time for
such a ritual. What we came up with was &lt;a href=&#34;http://electioncalendar.net/2006/&#34;&gt;the Election Day Advent
Calendar for 2006&lt;/a&gt;. The idea was simple: inspired by the
traditional Advent calendar for Christmas, our calendar let you open a
door a day through Election Day, and reveal interesting facts and quotes
about our democracy and the history of voting. It would be non-partisan
but not scrubbed of parties, a reflection on the many events and people
that comprise the story of the franchise.&lt;/p&gt;

&lt;p&gt;We wanted to make a real calendar that you could buy and hang up.
Neither of us had any experience in the print production world, and we
both had day jobs in different fields. We had to figure out all the
steps of the process, from hiring an artist to forming an LLC to sales
and shipping and marketing. We put up our own money to fund it, and
hoped to sell enough just to break even.&lt;/p&gt;

&lt;p&gt;The response to that first Calendar was strong, and told us there was a
desire for such products that let us all celebrate the shared history of
American politics. People were delighted by the concept; when they saw
it, they got it. We heard from teachers that it made a great part of
their back-to-school civics lesson plans, and from many people who said
they gave it out as a gift to a politics-nerd friend or colleague.&lt;/p&gt;

&lt;p&gt;After repeating the process in &lt;a href=&#34;http://electioncalendar.net/2008/&#34;&gt;2008&lt;/a&gt;, we took a break in 2010 but
didn’t give up on the core idea. What we needed, though, was a different
approach to paying for production—it was just too risky to put up our
own money time and again. In the meantime, along came Kickstarter. It’s
perfect for a project like ours.&lt;/p&gt;

&lt;p&gt;As I write, there are 6 days remaining in our campaign, and we’re a
little more than half way to our goal. If you’re reading these words and
like what I’ve described, &lt;strong&gt;&lt;a href=&#34;http://www.kickstarter.com/projects/electioncalendar/the-election-day-advent-calendar&#34;&gt;please support our Kickstarter&lt;/a&gt;&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Our motto with Gerrymander, the small company Ben and I founded for the
Calendar, is “Make Small Plans”. It’s a gently mocking riff on Daniel
Burnham’s famous and possibly apocryphal &lt;a href=&#34;http://www.ontko.com/pub/rayo/burnham.html&#34;&gt;quote&lt;/a&gt;. Our republic,
as great and large as it is, is still composed of the small democratic
actions of all of us, and those things require care and feeding, and
they ask to be done well. If the Election Day Advent Calendar provides
civic nourishment in any way, then it will have been a success.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Interview: Mike Migurski</title>
    <link href="/blog/2012/03/migurski.html" />
    <id>http://pauladamsmith.com/blog/2012/03/migurski.html</id>
    <updated>2012-03-30T03:45:00Z</updated>
    <content type="html">&lt;style&gt;
  dt {
    float: left;
    font-weight: bold;
    margin-right: 0.25em;
  }
  dt:after {
    content: &#34;:&#34;;
  }
  dd {
    margin: 0 0 1em 0;
    padding: 0;
  }
  .q + dd {
    font-weight: bold;
  }
  #map {
    height: 350px;
    width: 100%;
    border: none;
  }
&lt;/style&gt;
&lt;iframe id=&#34;map&#34; src=
&#34;http://maps.stamen.com/watercolor/embed#13/40.4404/-79.9928&#34;
name=&#34;map&#34;&gt;&lt;/iframe&gt;

&lt;p&gt;&lt;a href=&#34;http://mike.teczno.com/&#34;&gt;Mike Migurski&lt;/a&gt; is partner
and Director of Technology at &lt;a href=
&#34;http://stamen.com&#34;&gt;Stamen&lt;/a&gt; design studio in San Francisco. He
and his Stamen colleagues recently unveiled a new site, &lt;a href=
&#34;http://maps.stamen.com/&#34;&gt;maps.stamen.com&lt;/a&gt;, that included
three custom-rendered maps using data from &lt;a href=
&#34;http://openstreetmap.org/&#34;&gt;OpenStreetMap&lt;/a&gt;, including a
remarkable one that, despite being generated by algorithm from
precise vector data, resembled a hand-made watercolor
painting.&lt;/p&gt;

&lt;dl&gt;
  &lt;dt class=&#34;q&#34;&gt;Paul Smith&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;You’ve blogged about the process of creating the Terrain
    map tiles, and the code for the Toner tiles is open-sourced and on
    GitHub, but the Watercolor tiles seemed to come out of the
    blue. Can you talk about what inspired them, how you and your
    Stamen colleagues went about designing them, and what uses
    you imagined for them?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;Mike Migurski&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;The main use we imagined for them was that they would look
    really, really good, and unlike anything else being done with
    online maps. The process started with Eric Rodenbeck and Zach
    Watson kicking around some ideas on simulating the appearance
    of watercolor painting algorithmically, and expanded to
    include &lt;a href=
    &#34;http://www.flickr.com/photos/sensescape/sets/72157629121886440/&#34;&gt;
    Geraldine Sarmiento’s hand-done textures&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;We saw an amazing reaction to &lt;a href=
    &#34;http://www.20x200.com/blog/2011/11/aaron-straup-copes-prettymaps-across-the-us-of-a.html&#34;&gt;
    Aaron Straup Cope’s work on Prettymaps&lt;/a&gt; last year, and
    more generally a lot of interest in map-based art, so it
    seemed natural to try something that was algorithmic and at
    the same time had the appearance of being made by hand. I
    figured people would swallow their tongues in surprise when
    they saw these, especially when we switched from image search
    results for painted textures to pictures we were making
    ourselves for the project.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Making maps these days is often about mechanizing the
    conversion of vector data, like from &lt;abbr title=
    &#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt;, into raster images, which has
    meant perfecting our ability to layer and style points,
    lines, and polygons in very precise ways. I think what
    captivated people about the Watercolor tiles is that they
    seemed to color outside the lines, so to speak, in a way that
    didn’t seem possible with current tools. What tools did you
    use to generate the tiles, and how did you engineer them in a
    way to achieve this effect? Did you have to write new
    software to aid you?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;We did write new software, yes. We’ve been exploring ways
    to make &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; data more
    usable by cartographers over the past few years, and that’s
    largely been expressed in code designed to make large data
    sets easier for cartographers (and ourselves) to deal
    with:&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;a href=
        &#34;http://mike.teczno.com/notes/cascadenik.html&#34;&gt;Cascadenik&lt;/a&gt;
        was the first widespread application of CSS-like style
        rules in this area, since developed and expanded by
        Development Seed in Carto.
      &lt;/li&gt;

      &lt;li&gt;
        &lt;a href=&#34;http://tilestache.org/&#34;&gt;TileStache&lt;/a&gt; is a
        tile-generation server built to deploy custom
        visualization and rendering code.
      &lt;/li&gt;
    &lt;/ul&gt;

    &lt;aside class=&#34;pull&#34;&gt;I figured people would swallow their tongues in
    suprise when they saw these.&lt;/aside&gt;

    &lt;p&gt;I’ve been talking about this stuff for a few years, and
    the release of &lt;a href=
    &#34;http://maps.stamen.com/&#34;&gt;maps.stamen.com&lt;/a&gt; is intended to
    be a showcase that helps shift expectations of what good,
    online cartography should look like. It hasn’t been long
    since using a solid anti-aliased vector-rendering library
    like Mapnik was enough to make a strong showing against
    commercial map providers, but now we’re starting to establish
    new ideas around texture, color and labeling that require a
    layer of additional work beyond Mapnik.&lt;/p&gt;

    &lt;p&gt;Watercolor itself is a custom Provider to TileStache,
    feeding on simple Mapnik output and adding techniques like
    gaussian blur and Perlin noise as well as high-quality scans
    of actual water color paintings to achieve its effect. The
    development of watercolor had a number of stages, beginning
    with Zach’s experiments in noise and texture, Eric and George
    Oates’s encouragement, Geraldine’s addition of color and
    texture, and proceeding to my work with Jeff Easter and
    Nathaniel Kelso to improve performance until the code was
    good enough for public launch. The visual appearance is
    ridiculously CPU-hungry compared to your typical vector
    cartography, so we’ve got a few virtual servers on the moon
    doing the live calculation of new maps in new places.&lt;/p&gt;

    &lt;p&gt;Without diving too deeply into the actual watercolor code,
    we owe a lot to &lt;a href=
    &#34;http://www.mprove.de/script/90/KPT/index.html&#34;&gt;Kai Krause’s
    Algorithmic Painting&lt;/a&gt; ideas from almost 20 years ago.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I see that Stamen is releasing these tiles under a
    Creative Commons license as part of a Knight
    Foundation-funded project centered around data visualization
    and cities. City governments are historically big users of
    enterprise GIS software like ArcGIS; are there any lessons
    here for government or citizens, or does the work,
    specifically the Watercolor tiles, speak for themselves as
    art?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I think the latter: watercolor is basically art. Of course
    there’s an undeniable political component to the
    OpenStreetMap data it’s made of. In the U.S. &lt;abbr title=
    &#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; Foundation we’re interested in
    ways to get government at various levels to participate
    custodians of &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt;, and I
    think open data and enterprise GIS software can cooperate.
    Esri puts a lot of effort into OpenStreetMap-related efforts,
    and I’m not expecting to see their involvement in city
    governments wane.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Can you expand a bit on the interplay of vector data,
    raster data, and image filters to produce the tiles? What
    sort of preliminary work did you need to do to get the
    components parts to fall into place? Do you see patterns
    emerging and opportunities for abstraction for future artist
    map tools?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I probably can’t explain as well as &lt;a href=
    &#34;http://content.stamen.com/watercolor_process&#34;&gt;Zach just
    did&lt;/a&gt;.&lt;/p&gt;

    &lt;p&gt;As a bystander to this part of the process, it seemed like
    the actual simulation technique took shape in just a few
    days, based on Zach’s existing experience with image
    manipulation in Python. The real work came in the
    knob-twiddling, or as we call it internally, “spring tuning”
    (based on our experience with the Digg Swarm project from
    2007). &lt;a href=
    &#34;http://content.stamen.com/files/noise%20v%20threshold.jpg&#34;&gt;Here,
    for example, is one of Zach’s own parameter views&lt;/a&gt; that he
    used to tune noise thresholds for the ground texture.&lt;/p&gt;

    &lt;aside class=&#34;pull&#34;&gt;It’s intended to shift expectations of what
    good, online cartography should look like.&lt;/aside&gt;

    &lt;p&gt;I think the pattern that’s emerging for me is the raw
    labor-intensivity of this kind of work, the
    parameter-tweaking in a space of possible outcomes that
    results in something that looks right and feels exciting.
    Once the basic structure of noise, blur and threshold is in
    place, all you can really do is watch carefully as you
    repeatedly try combinations until something clicks.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;We’re usually talking about algorithms and stylesheets
    when we talk about web maps. Traditional cartographers often
    exercise artistic license over data streams as well—for
    example, manually but subtlety tweaking the curve of a road
    so that it reflects a shared or colloquial understanding of
    its location rather than it’s literal location. And then
    there are the more abstract but functional examples like
    subway system maps, whose stops and lines are not intended to
    be scale representations of their real-world counterparts. Do
    you see it possible for automated cartography to produce maps
    like these? What techniques would we need to develop (for
    example, a “hints” file ala typography for manually
    overriding certain points)?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I’ve not yet seen an attempt at automating this kind of
    cartography which has resulted in a satisfying outcome, but
    it’s still the subject of many PhD theses, so maybe it’s just
    too early. I suspect that we’ll end up seeing is a companion
    project to &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; where human
    make decisions about how things should be shown and
    contribute those to a free and open data source. Everything
    is still so manual in this world, and the subject of most
    maps doesn’t move around all that much, so you can really
    apply a human eye to get it right. Even with the watercolors,
    we had to do a lot of manual work to ensure that the
    1024×1024 watercolor texture blended cleanly and the various
    road sizes looked correct at each zoom level.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Regarding deployment. One of the challenges of producing
    raster map tiles for the web is the amount of storage and CPU
    time it takes to generate them; I notice that Stamen’s tiles
    are available down to zoom 18, which for a worldwide set
    means there are millions and millions of individual PNG
    files. To a degree CPU time can be amortized over the life of
    the project if you’re using a tile server to dynamically
    generate and cache tiles as users first request them, but
    even with commodity storage like S3, you’re talking about
    hundreds of GB or more. Are there knock-on challenges this
    presents for deployment and maintenance? Is there a
    sustainability plan for maps.stamen.com with regard to
    storage and bandwidth costs, or is Stamen as a company just
    going to eat those costs to provide this resource?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;We’re using a mix of physical and virtual machines for
    each of the tile sets we just released, blending the
    strengths and weaknesses of each. The CPU-intensive rendering
    of watercolor maps is done on Amazon EC2 where we can invoke
    extra machines as necessary, but the PostGIS, Mapnik and
    cache storage parts are all living on an actual server in a
    colocation facility. We decided last year to invest in
    physical hardware to take advantage of the high random-access
    speed of solid state disks, which make it possible to serve
    the entire OpenStreetMap planet database without incurring
    the overhead of Amazon’s terribly slow I/O speeds.&lt;/p&gt;

    &lt;p&gt;Fortunately, the back-end of this project is used to drive
    a lot of our other work, so we’re folding the cost into a
    series of different engagements that all use different
    components of the map tiles.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;We appear to be reaching a tipping point where rolling
    your own custom map stack seems not only practical but
    desirable for many applications. What is your reaction to the
    embrace of &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; by
    prominent technology companies, and the emergence of
    designer-friendly tools like TileMill? Do we have everything
    we need for most designers and developers to create the map
    experiences they want to provide? What tools would you’d like
    to see built; what data sets made available?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Honestly, I’m completely thrilled. With this year’s
    high-profile addition of Foursquare and Apple to the
    OpenStreetMap community, I’m looking forward to seeing what
    new artists and designers decide to do with maps—I can’t
    wait for the U.S. State Of The Map conference this
    autumn.&lt;/p&gt;

    &lt;aside class=&#34;pull&#34;&gt;Bitmap tiles have an equilibrium of performance,
    size and design that I don’t think will be disturbed any time
    soon.&lt;/aside&gt;

    &lt;p&gt;I think there are two issues that current tools don’t
    address well enough, and I’m excited to be working on them
    both: medium-scale data for counties and towns, and more
    options for bitmap filtering and output. I want Photoshop and
    Illustrator in the sky, essentially, and tools like TileMill
    help expose places where we need to be doing more with data
    before rendering and more with pixels after rendering.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Elaborate on what you mean by “medium-scale data”, and how
    it would improve map-making.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;My colleague Nathaniel Kelso runs a project called
    &lt;a href=&#34;http://www.naturalearthdata.com/downloads/&#34;&gt;Natural
    Earth Data&lt;/a&gt;, which offers global vector data at three
    different scales, optimized for rendering images of large
    regions, countries and continents, up to about zoom=9 if you
    think in terms of web slippy maps. OpenStreetMap meanwhile
    offers small-scale data down to the level of individual
    carriageways on major streets. There’s a gap between these
    two data sets where &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; is
    too detailed and Natural Earth is not detailed enough, so on
    many renderings you get bizarre selections of town names to
    render, doubled-up street names, or no global context.&lt;/p&gt;

    &lt;p&gt;The &lt;a href=&#34;http://maps.stamen.com/#terrain&#34;&gt;Terrain
    layer on maps.stamen.com&lt;/a&gt; is a vehicle for exploring a few
    avenues through this problem: feature generalization for
    route shields and large street names using the &lt;a href=
    &#34;http://github.com/migurski/Skeletron&#34;&gt;Skeletron&lt;/a&gt; library,
    simulated annealing for smarter label placement with &lt;a href=
    &#34;https://github.com/migurski/Dymo&#34;&gt;Dymo&lt;/a&gt;, and &lt;a href=
    &#34;https://github.com/migurski/DEM-Tools&#34;&gt;cross-blending of
    raster data sets for ground cover and hill shading&lt;/a&gt;. We’re
    doing a lot of work to make &lt;abbr title=
    &#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; data better for rendering, and
    releasing all the component parts as software for processing
    data sets.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Do you see Mapnik as the appropriate place to grow the
    bitmap filtering and output functions?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;As far as Mapnik’s role in all this, I think it’s the
    single best place to do vector rendering, but I’m looking
    elsewhere for filtering and output. I prefer to use tools
    that are specialized for individual tasks, so we use the
    pixel output of Mapnik as a source for Python-based pixel
    manipulation code, often implemented in libraries like NumPy
    that offer rapid manipulation of bitmap arrays.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;It sounds like you’re hinting at a new program for this
    kind of manipulation. You and Stamen have contributed a great
    deal of open-source map making software over the years; will
    the code that created Watercolors be released?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I hope I’m not sounding too coy; there’s not any secret
    piece of software running the show, just a set of well-known
    techniques in a new arrangement. I’ve released everything
    I’ve ever started, but my role in Watercolor was more about
    taking something that already worked and making it work a
    little better so more people could see it.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Most web maps are a pre-baked set of raster images
    assembled in the viewport of the browser—do you see this
    fundamental arrangement changing in the foreseeable future?
    With WebGL and HTML5 Canvas, are we ready to composite maps
    client-side with servers pushing vectors data over the wire?
    What tradeoffs are there here? Do you think you could do
    Watercolors entirely in the browser anytime soon?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I don’t think we’re far off, though there are a few
    impediments still in the way. Much of the core functionality
    of Watercolor’s bitmap effects can be implemented entirely on
    a GPU in a WebGL fragment shader, so there’s no reason that
    we couldn’t build it that way. As far as shipping vectors,
    I’d love to see it happen. It’s actually not unrelated to the
    work we’re doing with differently-scaled data: you want your
    underlying data to be at the “right” level of complexity, and
    that generally means modifying it in some way, by dropping
    extra points, scrunching narrow polygons into lines, making
    small things disappear, and lumping groups of things together
    into single blobs. If we can figure out a better way to
    simplify on the fly, then complete client-side rendering
    could be a reality. Of course, Google has already done a lot
    of this themselves, but it’s different when the open source
    community does it and shares the results and the
    research.&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Simplification of lines and polygons is a common need for
    mapping projects, not only for display but also for
    interaction—clients can only handle so many points during the
    refresh cycle. It can be a big challenge for workflows to
    simplify vectors, and also to preserve topology, the
    relationship between shapes—our model is of disconnected
    points, lines, and polygons. That’s one reason I’m excited
    about topology as a type coming in PostGIS 2.0. What
    simplification techniques should we be using and exploring,
    both on the algorithm side as well as the workflow side?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;I spent about two years (off and on) researching line
    generalization. Skeletron went through three iterations,
    starting with a port of the straight skeleton technique from
    &lt;a href=&#34;http://teczno.com/s/vkp&#34;&gt;Tom Kelly’s
    description&lt;/a&gt;, to a collaboration with Schuyler Erle
    binding to the &lt;a href=&#34;http://teczno.com/s/vlv&#34;&gt;CGAL library
    from Python&lt;/a&gt;, finally settling on an application of the
    &lt;a href=&#34;http://teczno.com/s/2trs&#34;&gt;Voronoi diagram first
    published by Esri&lt;/a&gt; in 1996. All the way through, I kept
    thinking that there just had to be an easier way to make
    simple lines out of complex ones, and why wasn’t I finding
    code to do it for me? The simplification techniques we should
    explore are all known and published, but exist largely as
    plugins for systems like ArcGIS, instead of chainable tools
    in the Unix style. PostGIS 2.0 is going to help in a big way,
    and I hope that some of that effort migrates out to tools for
    managing workflows around flat files.&lt;/p&gt;

    &lt;aside class=&#34;pull&#34;&gt;All you can really do is watch carefully as you
    repeatedly try combinations until something clicks.&lt;/aside&gt;

    &lt;p&gt;If all goes well, it should start to make sense to ship
    vectors over the wire and render them on the client.&lt;/p&gt;

    &lt;p&gt;It’s an interesting question to me whether client-side
    rendering really something we want to aim for, though. Bitmap
    tiles have an equilibrium of performance, size and design
    that I don’t think will be disturbed any time soon. I’m
    learning what I can about GPUs to be ready when the day
    comes, but in the meantime most of my focus is on developing
    workflows for data. &lt;abbr title=&#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt;
    extracts are one aspect of this; simplifying &lt;abbr title=
    &#34;OpenStreetMap&#34;&gt;OSM&lt;/abbr&gt; data and standing up fresh new
    rendering databases from source data is another. The
    scaffolding that makes life easiest is a combination of bias
    toward flat files and Postel’s Law: don’t screw around with
    “seamless” servers, publish data flat using old file formats,
    and only invent brand new things when they’re needed.
    Spherical Mercator slippy map tiles are fast becoming one of
    those well-understood old file formats, so this is what we’ve
    aimed for with Watercolor; otherwise, how could we have a
    section on maps.stamen.com showing how to use the imagery in
    your own applications?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt class=&#34;q&#34;&gt;PS&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;That’s interesting—so are you generally fine with the way
    Spherical Mercator has colonized the web map world? It seems
    to have been a decision purely about tradeoffs: what
    projection “works” for world-wide maps all the way down to
    zoom level 22, or however detailed Google Maps gets these
    days. But clearly choice of projection is a never-ending
    debate. Is Spherical Mercator an acceptable enough
    constraint, from your perspective, within which to do the
    kind of artistic expression Stamen does, and maintain
    interoperability?&lt;/p&gt;
  &lt;/dd&gt;

  &lt;dt&gt;MM&lt;/dt&gt;

  &lt;dd&gt;
    &lt;p&gt;Oh yeah, I’m absolutely fine with it. It’s one of those
    “assume a spherical chicken” engineering solutions that
    actually leads to so much follow-on innovation that in
    retrospect I’m glad no one was letting the cartographers
    drive at Google in 2005. Projections only matter when you’re
    looking at large areas, and that’s really not the case when
    you’re searching for driving directions or checking out the
    neighborhood where you spent elementary school. It’s
    interesting to me, though, that the typical fifty states map
    you see on every link bait infographic out there is based on
    a conic projection—it’s about what looks right for a genre of
    mapmaking, and in the case of slippy maps the Spherical
    Mercator is clearly the obvious choice.&lt;/p&gt;
  &lt;/dd&gt;
&lt;/dl&gt;

&lt;p&gt;—&lt;a href=&#34;http://twitter.com/paulsmith&#34; title=&#34;Follow me on Twitter&#34;&gt;@paulsmith&lt;/a&gt;&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Going to work for Democrats</title>
    <link href="/blog/2011/09/dnc.html" />
    <id>http://pauladamsmith.com/blog/2011/09/dnc.html</id>
    <updated>2011-09-04T16:00:00Z</updated>
    <content type="html">&lt;p&gt;&lt;img src=&#34;/images/eb-to-dnc.png&#34; style=&#34;display: block; float: right; margin-left: 15px&#34;&gt;&lt;/p&gt;

&lt;p&gt;I have some exciting news: in a couple of weeks, I will be the new deputy
director of technology at the &lt;a href=&#34;http://www.democrats.org/&#34;&gt;Democratic National Committee&lt;/a&gt;. I’ll
be helping to create software that helps get Democrats elected. It’s
a great opportunity for me to do what I love for an organization that I
passionately support. I hope to help make the technology department there
top-notch in terms of software engineering practices, bringing what I’ve
learned from having helped develop, deploy, and grow &lt;a href=&#34;http://www.everyblock.com/&#34;&gt;EveryBlock&lt;/a&gt;. And
I’ll have some projects of my own, which will hopefully advance the
state of campaign software somewhat. It’s especially exciting, too, to
be able to collaborate with &lt;a href=&#34;http://twitter.com/harper&#34;&gt;friends&lt;/a&gt; &lt;a href=&#34;http://twitter.com/detour1999&#34;&gt;in&lt;/a&gt; &lt;a href=&#34;http://twitter.com/gabaug&#34;&gt;Chicago&lt;/a&gt;
&lt;a href=&#34;http://twitter.com/scottvdp&#34;&gt;working&lt;/a&gt; &lt;a href=&#34;http://twitter.com/aconbere&#34;&gt;on&lt;/a&gt; &lt;a href=&#34;http://www.barackobama.com/&#34;&gt;that one campaign&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I have been volunteering on political campaigns—federal, state, and
local races—for years, and have often lamented the state of campaign
software. It’s partly understandable, because campaigns tend to be
all-hands-on-deck, hair-on-fire affairs, where it’s hard to justify
long-range planning and software development, even if it might make
the lives of your staff, organizers and volunteers easier, since your
organization may not even exist for more than a few months. And campaigns
rarely have in-house software engineers, so opportunities to capture and
encode knowledge in the form of software, and explore new technologies,
are missed.&lt;/p&gt;

&lt;p&gt;Obama For America gets this—that’s why they’ve hired like a start-up
for this campaign cycle, recognizing that great software is a competitive
advantage and no longer an afterthought you contract out for. And the DNC
gets it, too, and that’s why I’m excited to join them. The chance to
help re-elect this president, restore Democratic majorities in Congress,
and also to help down-ballot Democrats across the country in this and
future campaign cycles is one I couldn’t pass up.&lt;/p&gt;

&lt;p&gt;I’ll be commuting to the DNC’s offices in Washington, D.C. from Baltimore
on a regular basis, though I’ll still be working from home a couple of days
each week, so that I won’t too miss much of &lt;a href=&#34;/blog/2011/08/maxine.html&#34;&gt;this kind of stuff&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It’s a bittersweet development, because I’ll be leaving EveryBlock,
which I helped found 4 years ago. With the success of the &lt;a href=&#34;http://blog.everyblock.com/2011/mar/21/redesign/&#34;&gt;recent
relaunch&lt;/a&gt;, though, I feel now is as good a time as any to step
away. The site is in great hands, and the response from users to the
new version has been enthusiastic. It couldn’t have a better home than
&lt;a href=&#34;http://www.msnbc.com/&#34;&gt;msnbc.com&lt;/a&gt;, who have provided great guidance and resources. I’m
thrilled with the success we’ve had and for how far it’s come, and
I’m confident that it will continue to be the best place on the internet
to help make your block a better place.&lt;/p&gt;

&lt;p&gt;I am particularly grateful for having worked with my great EveryBlock
colleagues. I’m humbled by them and their talents and work ethic. It
was a privilege to learn from them and improve my craft, however modestly,
by their examples.&lt;/p&gt;

&lt;p&gt;For now, I’m focusing on winding down at EveryBlock, and getting prepared
for a new commute (I’ll try to hack it with the MARC train and a bike)
and a campaign season now fully engaged. It’s a thrilling opportunity,
and I hope to make the most of it.&lt;/p&gt;

&lt;p&gt;—&lt;a href=&#34;http://twitter.com/paulsmith&#34;&gt;@paulsmith&lt;/a&gt;&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Maxine</title>
    <link href="/blog/2011/08/maxine.html" />
    <id>http://pauladamsmith.com/blog/2011/08/maxine.html</id>
    <updated>2011-08-27T20:10:00Z</updated>
    <content type="html">&lt;p&gt;&lt;a href=&#34;http://www.flickr.com/photos/psmith/6076865981/&#34; title=&#34;P1040879.jpg by pauladamsmith, on Flickr&#34;&gt;&lt;img src=&#34;http://farm7.static.flickr.com/6184/6076865981_a0c284c99a.jpg&#34; width=&#34;500&#34; height=&#34;334&#34; alt=&#34;P1040879.jpg&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One month ago today, Maxine Mills Smith arrived in this world. Her mom gave
birth to her at Mercy Medical Center in Baltimore, Maryland, at six in the
morning. She was, and continues to be, a long and strong gal. She enjoys
being carried about and looking up at the changing scenery. Like her father,
she zonks out to the motion of a vehicle ride, be it stroller or car. She
has healthy lungs, likes to exercise them, and is a vocal chirper. She
has been respecting her mom and dad with 5 and 6-hour stretches of sleep
at night, but likes to mix it up from time to time and throw her mom some
napless curveballs. When she is awake, she is bright and alert. Given the
choice, she’d rather have some light assistance and try to stand and
monster march (I said she was strong) than squirm around on her belly like
a beetle.  Her binky is a frequent companion, and she is a champion eater
of mom’s milk.  The doctors and nurses at the pediatrician’s office
think she is doing fine, and give her an extra wink. We think she’s is
doing fine, too. Family love Maxine. Welcome home, my daughter.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Parsing and formatting date/time in Go</title>
    <link href="/blog/2011/05/go_time.html" />
    <id>http://pauladamsmith.com/blog/2011/05/go_time.html</id>
    <updated>2011-05-20T02:00:00Z</updated>
    <content type="html">&lt;p&gt;Go takes an interesting approach to &lt;a href=&#34;http://golang.org/pkg/time/&#34;&gt;parsing strings to time objects,
and formatting time objects as strings&lt;/a&gt;. Instead of using codes like
most languages to represent component parts of a date/time string
representation—like &lt;code&gt;%Y&lt;/code&gt; for a 4-digit year like “2011” or &lt;code&gt;%b&lt;/code&gt;
for an abbreviated month name like “Feb”—Go uses a mnemonic device:
there is a standard time, which is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Mon Jan 2 15:04:05 MST 2006  (MST is GMT-0700)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Or put another way:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;01/02 03:04:05PM &amp;#39;06 -0700
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Instead of having to remember or lookup the traditional formatting codes for
functions like &lt;code&gt;strftime&lt;/code&gt;, you just count one-two-three-four and each place
in the standard time corresponds to a component of a date/time object (the
&lt;code&gt;Time&lt;/code&gt; type in Go): one for day of the month, two for the month, three for
the hour (in 12-hour time), four for the minutes, etc.&lt;/p&gt;

&lt;p&gt;The way you put this into action is by putting together the parts of
the standard time in a layout string that matches the format of either
the string representation you want to parse into a &lt;code&gt;Time&lt;/code&gt; object or the
opposite direction, when you want to generate a string representation from
an &lt;code&gt;Time&lt;/code&gt; object.&lt;/p&gt;

&lt;p&gt;Parsing:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package main

import (
    &amp;quot;fmt&amp;quot;
    &amp;quot;time&amp;quot;
)

func main() {
    value  := &amp;quot;Thu, 05/19/11, 10:47PM&amp;quot;
    // Writing down the way the standard time would look like formatted our way
    layout := &amp;quot;Mon, 01/02/06, 03:04PM&amp;quot;
    t, _ := time.Parse(layout, value)
    fmt.Println(t)
}

// =&amp;gt; &amp;quot;Thu May 19 22:47:00 +0000 2011&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Formatting:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package main

import (
    &amp;quot;fmt&amp;quot;
    &amp;quot;time&amp;quot;
)

func main() {
    t := time.SecondsToLocalTime(1305861602)
    t.ZoneOffset = -4*60*60
    fmt.Println(t.Format(&amp;quot;2006-01-02 15:04:05 -0700&amp;quot;))
}

// =&amp;gt; &amp;quot;2011-05-20 03:20:02 -0400&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are predefined constants in the &lt;code&gt;time&lt;/code&gt; package for common formats
such as RFCs 822 and 3339.&lt;/p&gt;

&lt;p&gt;The use of a mnemonic over obscure formatting codes I think reflects the
pragmatism of Go’s developers and their focus on creating a language
that makes its users more productive. While it is a break with tradition
to abandon &lt;code&gt;strftime&lt;/code&gt;-style formatting, they probably recognized that most
developers, no matter how experienced, reach for &lt;code&gt;man strftime&lt;/code&gt; or similar
documentation more often than not (hell, I have a mug with the codes printed
on it), and each time they do, it is an expensive context switch, in terms
of lost focus. Writing the standard time down the way yours looks may be
quirky, but it&amp;#39;s easy to recall, and it also happens to match the shape of
your time string, syntatically.&lt;/p&gt;

&lt;p&gt;It’s fascinating to see a language with the pedigree of Go—from the
minds of long-time C and Unix developers—toss aside certain old and
venerable ways of doing things. But it’s consistent with a language
that’s relatively small (in the good way of being comprehensible and
coherent), focused on efficiency, and careful in what it includes.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>A partial list of metaphors, visual and otherwise, anti-skeuomorphism zealots have to tackle to reach utopia</title>
    <link href="/blog/2011/04/floppy.html" />
    <id>http://pauladamsmith.com/blog/2011/04/floppy.html</id>
    <updated>2011-04-05T18:48:00Z</updated>
    <content type="html">&lt;p&gt;&lt;img src=&#34;/images/icons.jpg&#34; alt=&#34;icons&#34;&gt;
Motivated by irrational hatred and overstated claims of the continuing
utility of a 3.5&amp;quot; floppy disk icon to mean “save”:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Handset icon, meaning “phone,” on every iPhone, Android&lt;/li&gt;
&lt;li&gt;e&lt;strong&gt;mail&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Web&lt;strong&gt;site&lt;/strong&gt; (implies a physical place)&lt;/li&gt;
&lt;li&gt;Wrench or cog icon, meaning “settings” or “preferences”&lt;/li&gt;
&lt;li&gt;Shopping cart icon&lt;/li&gt;
&lt;li&gt;Clock with analog hands, meaning “time” or time-centric application&lt;/li&gt;
&lt;li&gt;Incandescent light bulb, several meanings, including energy settings&lt;/li&gt;
&lt;li&gt;Bound, paper book, meaning “book”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Of course there are many, many anachronistic interface elements and metaphors
in the world, and &lt;a href=&#34;/blog/2010/10/old_things.html&#34;&gt;we get by okay&lt;/a&gt;. Mainly,
this is because new generations don’t suddenly appear next to us and
start using our computers without any foreknowledge of the metaphorical
items. They spend time learning with the old fogeys for whom information was
sometimes stored inside square pieces of plastic and metal. This overlap is
necessary in general because knowledge about tools is not encoded in our
genetic material. All understanding of &lt;em&gt;use&lt;/em&gt; is part of a multi-layered
strata of culture, experience, and relationships.&lt;/p&gt;

&lt;p&gt;The real problem anti-floppy-disk people have is explaining a harm,
specifically, a harm that matters. Often when we think of user interface
improvements that matter, we think of examples like improving medical devices
to reduce user error, changes that literally save people’s lives. Or
tweaks to software that improve user efficiency and productivity, saving
money. It’s hard to conceive of what might be improved by finding a better
metaphor for “save” other than some designers’ personal sensibilities.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>More Redis internals: Tracing a GET & SET</title>
    <link href="/blog/2011/03/redis_get_set.html" />
    <id>http://pauladamsmith.com/blog/2011/03/redis_get_set.html</id>
    <updated>2011-03-10T19:48:00Z</updated>
    <content type="html">&lt;p&gt;In my &lt;a href=&#34;/articles/redis-under-the-hood.html&#34;&gt;previous article&lt;/a&gt;, I took a
superficial look at how Redis starts up and prepares itself to process
commands. In this article, I&amp;#39;ll follow a &lt;code&gt;GET&lt;/code&gt; and a &lt;code&gt;SET&lt;/code&gt; command as
they move from client through the server and back. The &lt;code&gt;GET&lt;/code&gt; will be for
a key that doesn&amp;#39;t exist, and the &lt;code&gt;SET&lt;/code&gt; will set that key.  Then I&amp;#39;ll look
quickly at a subsequent &lt;code&gt;GET&lt;/code&gt; and how it differs.&lt;/p&gt;

&lt;p&gt;As before, I&amp;#39;m exploring Redis with the source code open in my editor and
indexed with a &lt;code&gt;tags&lt;/code&gt; file, and the Redis server running under &lt;code&gt;gdb&lt;/code&gt; in
another terminal.&lt;/p&gt;

&lt;p&gt;Caveat: this article was written against the codebase of Redis 2.2.1. With
respect to my previous article, for a list of what has changed in Redis since
I wrote it, see this &lt;a href=&#34;http://news.ycombinator.com/item?id=2301804&#34;&gt;comment on
HN&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Edit:&lt;/strong&gt; I made two minor changes based on feedback—Redis keys are not Redis
objects, they are &lt;code&gt;sds&lt;/code&gt; strings; and you don’t have to hack the Makefile to
compile without optimizations.&lt;/p&gt;

&lt;h1&gt;GET&lt;/h1&gt;

&lt;p&gt;Let&amp;#39;s execute the command &lt;code&gt;get users:1234&lt;/code&gt; on Redis.&lt;/p&gt;

&lt;h2&gt;Preparing&lt;/h2&gt;

&lt;p&gt;If you inspect certain variables under &lt;code&gt;gdb&lt;/code&gt;, you might not get what you want.
Instead you see a message like &amp;quot;&lt;value temporarily unavailable, due to
optimizations&gt;.&amp;quot; This is because the compiler has optimized the machine code
in such a fashion that the portion of memory you wanted to look at that was
never used, at least for the variable under inspection. To make stepping
through the code and inspecting a little easier, we make sure that Redis is
not compiled with optimizations. You can do this by either building Redis with
the following invocation:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;make noopt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;or by setting an environment variable:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;OPTIMIZATION= make
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;Sending the command from the client&lt;/h2&gt;

&lt;p&gt;If we look at the &lt;code&gt;repl&lt;/code&gt; loop of redis-cli, we see that it uses the
&lt;code&gt;linenoise&lt;/code&gt; library to split the arguments of the command. It dispatches on
the first argument. The loop checks for client commands that aren&amp;#39;t processed
as a command by the Redis server, like &lt;code&gt;exit&lt;/code&gt;/&lt;code&gt;quit&lt;/code&gt;, &lt;code&gt;clear&lt;/code&gt; (to clear the screen),
and &lt;code&gt;connect&lt;/code&gt; (which is a way to connect to a specified Redis server on host
port, instead of the default host of 127.0.0.1 and port of 6379.&lt;/p&gt;

&lt;p&gt;Any other argument is considered the name of a command to send to the server.
The remaining arguments are the arugments for that command.&lt;/p&gt;

&lt;p&gt;We&amp;#39;re trying to get the on-the-wire representation of the &lt;code&gt;get users:1234&lt;/code&gt; command.
redis-cli uses a &lt;code&gt;redisContext&lt;/code&gt; struct to encapsulate the state of the
connection to the server, as well as the output buffer where the command in
the form of the Redis protocol is written for sending to the server. We know
from reading the source of hiredis (the Redis C client library that the redis-cli
program is built on) that the &lt;code&gt;obuf&lt;/code&gt; field is where the raw command is stored:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# hiredis.h:107
/* Context for a connection to Redis */
typedef struct redisContext {
    int fd;
    int flags;
    char *obuf; /* Write buffer */
    int err; /* Error flags, 0 when there is no error */
    char *errstr; /* String representation of error when applicable */

    /* Function set for reply buildup and reply reader */
    redisReplyObjectFunctions *fn;
    void *reader;
} redisContext;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we set a breakpoint on &lt;code&gt;cliReadReply&lt;/code&gt;, we can inspect the output buffer and
see exactly how the command looks as a bytestring bound for the server.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;client $ gdb src/redis-cli
(gdb) b cliReadReply
(gdb) run
Starting program: /home/paul/src/redis-2.2.0-RC2/src/redis-cli 
Reading symbols for shared libraries +. done
redis&amp;gt; get users:1234

Breakpoint 1, cliReadReply (output_raw_strings=0) at redis-cli.c:421
421         if (redisGetReply(context,&amp;amp;_reply) != REDIS_OK) {
(gdb) p context-&amp;gt;obuf 
$1 = 0x100102428 &amp;quot;*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We see that the Redis command &lt;code&gt;get users:1234&lt;/code&gt; as entered in our client is
translated to &lt;code&gt;*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n&lt;/code&gt;. Any Redis client is
going to convert our command expressed in its respective syntax to the same
on-the-wire format. So in Python:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; redis_client.get(&amp;#39;users:1234&amp;#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;will send the same &lt;code&gt;*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n&lt;/code&gt; bytestring to
the server. &lt;/p&gt;

&lt;p&gt;Let&amp;#39;s print that bytestring to screen and render those `\r\n&amp;#39;s as line feeds
so we can see an expanded view and get a better look at the protocol.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;*2
$3
get
$10
users:1234
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first bit is &lt;code&gt;*2&lt;/code&gt;, which tells us that the arity of the command,
including the command name, is 2. That is, the server should expect two
arguments to follow.&lt;/p&gt;

&lt;p&gt;The next bit is &lt;code&gt;$3&lt;/code&gt;, which means that the length of the first argument in
bytes is 3. The argument itself follows, our command name, &lt;code&gt;get&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The next bit after that is &lt;code&gt;$10&lt;/code&gt;, so the length in bytes of the second
argument is 10. Our one and only argument to the command is next,
&lt;code&gt;users:1234&lt;/code&gt;, the key we are trying to &lt;code&gt;get&lt;/code&gt;.&lt;/p&gt;

&lt;h2&gt;Receiving the command on the server&lt;/h2&gt;

&lt;p&gt;If you remember from the last article, &lt;code&gt;readQueryFromClient&lt;/code&gt; is a good place
to set a breakpoint in your debugger on the server side for inspecting an
inbound client command.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;server $ gdb src/redis-server
(gdb) b readQueryFromClient
Breakpoint 1 at 0x100011445: file networking.c, line 882.
(gdb) run redis.conf
Starting program: /home/paul/src/redis-2.2.0-RC2/src/redis-server redis.conf
Reading symbols for shared libraries +. done
[63700] 01 Mar 11:04:40 * Server started, Redis version 2.2.1
[63700] 01 Mar 11:04:40 * The server is now ready to accept connections on port 6379
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now back in the terminal with the client running in the debugger, continue to
send the command to the server, which will stop at the breakpoint we set.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# client
(gdb) c
Continuing.

# server
Breakpoint 1, readQueryFromClient (el=0x100200000, fd=5, privdata=0x100804e00, mask=1) at networking.c:801
801     void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask) {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;#39;s step to the following line:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# src/networking.c:808
nread = read(fd, buf, REDIS_IOBUF_LEN);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we step to here in our debugger, we see that the server read 30 bytes. If
you count the number of bytes in our Redis protocol-encoded command,
&lt;code&gt;*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n&lt;/code&gt;, you&amp;#39;ll see it&amp;#39;s 30. Just for good
measure, let&amp;#39;s look at the 30 bytes beginning at the memory location pointed
to by &lt;code&gt;buf&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) p nread
30
(gdb) x/30cb buf
0x7fff5fbfeaf0: 42 &amp;#39;*&amp;#39;  50 &amp;#39;2&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 36 &amp;#39;$&amp;#39;  51 &amp;#39;3&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39;
0x7fff5fbfeaf8: 71 &amp;#39;G&amp;#39;  69 &amp;#39;E&amp;#39;  84 &amp;#39;T&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 36 &amp;#39;$&amp;#39;  49 &amp;#39;1&amp;#39;  48 &amp;#39;0&amp;#39;
0x7fff5fbfeb00: 13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 117 &amp;#39;u&amp;#39; 115 &amp;#39;s&amp;#39; 101 &amp;#39;e&amp;#39; 114 &amp;#39;r&amp;#39; 115 &amp;#39;s&amp;#39; 58 &amp;#39;:&amp;#39;
0x7fff5fbfeb08: 49 &amp;#39;1&amp;#39;  50 &amp;#39;2&amp;#39;  51 &amp;#39;3&amp;#39;  52 &amp;#39;4&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we can see our whole command bytestring is there, byte by byte.&lt;/p&gt;

&lt;p&gt;The server has now read in the entirety of our command in one step.  (Because
we had a relatively short command, one that fits inside a kernel buffer, and
we are the only client on a loopback network device, this is the case, but it
need not be. Since Redis is event-driven, this function,
&lt;code&gt;readQueryFromClient&lt;/code&gt;, is called whenever there are bytes from buffers to be
read. If our command was particularly long, or there was a lot of network
contention, the command may take more than one I/O event before it is fully
read. For this reason, Redis builds up a buffer per client and appends bytes
to it on each call to this function. It only proceeds with processing the
command when it has been fully read. But we don&amp;#39;t need to consider this in our
simple example, so we will proceed.)&lt;/p&gt;

&lt;p&gt;We&amp;#39;re going to elide the processing of the input buffer. This is the point
where the server takes the Redis protocol-encoded bytestring of our request
and unpacks it into arguments on the client struct object. If you are
interested in the details of that parsing, examine the function
&lt;code&gt;processMultibulkBuffer&lt;/code&gt; in &lt;code&gt;networking.c&lt;/code&gt;. All we are interested in at this
point is that the &lt;code&gt;argc&lt;/code&gt; member of the client object is the number of command
arguments (counting the command name itself) and &lt;code&gt;argv&lt;/code&gt; is a pointer to the
list of arguments.&lt;/p&gt;

&lt;p&gt;The bit of code we care at this point is &lt;code&gt;processCommand&lt;/code&gt;. The first thing the
server does is look up the command in its command table (see &amp;quot;Setting up
command table&amp;quot; in the previous article, but note that this lookup is now O(1),
see the HN thread linked above). Assuming the command is found (which our
&lt;code&gt;get&lt;/code&gt; will be), the server will double-check that the arity of the command as
defined in the command table matches the number of arguments received from the
client (&lt;code&gt;c-&amp;gt;argc&lt;/code&gt;).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.c:998
cmd = lookupCommand(c-&amp;gt;argv[0]-&amp;gt;ptr);
if (!cmd) {
    addReplyErrorFormat(c,&amp;quot;unknown command &amp;#39;%s&amp;#39;&amp;quot;,
        (char*)c-&amp;gt;argv[0]-&amp;gt;ptr);
    return REDIS_OK;
} else if ((cmd-&amp;gt;arity &amp;gt; 0 &amp;amp;&amp;amp; cmd-&amp;gt;arity != c-&amp;gt;argc) ||
           (c-&amp;gt;argc &amp;lt; -cmd-&amp;gt;arity)) {
    addReplyErrorFormat(c,&amp;quot;wrong number of arguments for &amp;#39;%s&amp;#39; command&amp;quot;,
        cmd-&amp;gt;name);
    return REDIS_OK;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Skip down to the end of &lt;code&gt;processCommand&lt;/code&gt;. Because our humble &lt;code&gt;get&lt;/code&gt; is not a
&amp;quot;multi&amp;quot; command like &lt;code&gt;mget&lt;/code&gt;, &lt;code&gt;mset&lt;/code&gt;, etc., it doesn&amp;#39;t require queue-like
processing of the underlying multiple commands, so we go right to &lt;code&gt;call&lt;/code&gt;,
which is where our command is dispatched.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.c:953
void call(redisClient *c, struct redisCommand *cmd) {
    long long dirty;

    dirty = server.dirty;
    cmd-&amp;gt;proc(c);
    dirty = server.dirty-dirty;

    if (server.appendonly &amp;amp;&amp;amp; dirty)
        feedAppendOnlyFile(cmd,c-&amp;gt;db-&amp;gt;id,c-&amp;gt;argv,c-&amp;gt;argc);
    if ((dirty || cmd-&amp;gt;flags &amp;amp; REDIS_CMD_FORCE_REPLICATION) &amp;amp;&amp;amp;
        listLength(server.slaves))
        replicationFeedSlaves(server.slaves,c-&amp;gt;db-&amp;gt;id,c-&amp;gt;argv,c-&amp;gt;argc);
    if (listLength(server.monitors))
        replicationFeedMonitors(server.monitors,c-&amp;gt;db-&amp;gt;id,c-&amp;gt;argv,c-&amp;gt;argc);
    server.stat_numcommands++;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;#39;s focus on line 952, &lt;code&gt;cmd-&amp;gt;proc(c);&lt;/code&gt;. This is Redis&amp;#39;s dynamic dispatching
of command function calling. Redis makes this clean and simple by
encapsulating commands and giving all the actual underlying command functions
the same function signature, taking our client object, which carries the
payload of our command&amp;#39;s arguments. So we&amp;#39;re interested in looking into the
details of the Redis command object and the actual function that will handle
our &lt;code&gt;get&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.h:504
struct redisCommand {
    char *name;
    redisCommandProc *proc;
    int arity;
    int flags;
    /* Use a function to determine which keys need to be loaded
     * in the background prior to executing this command. Takes precedence
     * over vm_firstkey and others, ignored when NULL */
    redisVmPreloadProc *vm_preload_proc;
    /* What keys should be loaded in background when calling this command? */
    int vm_firstkey; /* The first argument that&amp;#39;s a key (0 = no keys) */
    int vm_lastkey;  /* THe last argument that&amp;#39;s a key */
    int vm_keystep;  /* The step between first and last key */
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we pop up to the top of &lt;code&gt;redis.c&lt;/code&gt;, we see the definition of the Redis command
table, and our &lt;code&gt;get&lt;/code&gt; is the first entry.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.c:71
struct redisCommand readonlyCommandTable[] = {
    {&amp;quot;get&amp;quot;,getCommand,2,0,NULL,1,1,1},
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;getCommand&lt;/code&gt; is the function that does the actual work for our command.
It&amp;#39;s a thin wrapper for &lt;code&gt;getGenericCommand&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# t_string.c:62
int getGenericCommand(redisClient *c) {
    robj *o;

    if ((o = lookupKeyReadOrReply(c,c-&amp;gt;argv[1],shared.nullbulk)) == NULL)
        return REDIS_OK;

    if (o-&amp;gt;type != REDIS_STRING) {
        addReply(c,shared.wrongtypeerr);
        return REDIS_ERR;
    } else {
        addReplyBulk(c,o);
        return REDIS_OK;
    }
}

void getCommand(redisClient *c) {
    getGenericCommand(c);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The arguments to &lt;code&gt;lookupKeyReadOrReply&lt;/code&gt; are the client object, the key
&lt;code&gt;users:1234&lt;/code&gt; we&amp;#39;re trying to look up, and an object, &lt;code&gt;shared.nullbulk&lt;/code&gt; that
will be the default reply to the client if the key is not found.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# db.c:58
robj *lookupKeyReadOrReply(redisClient *c, robj *key, robj *reply) {
    robj *o = lookupKeyRead(c-&amp;gt;db, key);
    if (!o) addReply(c,reply);
    return o;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;lookupKeyRead&lt;/code&gt; is a thin wrapper for &lt;code&gt;lookupKey&lt;/code&gt; that handles removing keys
that have been set to expire.&lt;/p&gt;

&lt;p&gt;Now we get to the heart of the &lt;code&gt;get&lt;/code&gt; command -- looking up the key in the
database.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# db.c:9
robj *lookupKey(redisDb *db, robj *key) {
    dictEntry *de = dictFind(db-&amp;gt;dict,key-&amp;gt;ptr);
    if (de) {
        robj *val = dictGetEntryVal(de);

        /* Update the access time for the aging algorithm.
         * Don&amp;#39;t do it if we have a saving child, as this will trigger
         * a copy on write madness. */
        if (server.bgsavechildpid == -1 &amp;amp;&amp;amp; server.bgrewritechildpid == -1)
            val-&amp;gt;lru = server.lruclock;

        if (server.vm_enabled) {
            if (val-&amp;gt;storage == REDIS_VM_MEMORY ||
                val-&amp;gt;storage == REDIS_VM_SWAPPING)
            {
                /* If we were swapping the object out, cancel the operation */
                if (val-&amp;gt;storage == REDIS_VM_SWAPPING)
                    vmCancelThreadedIOJob(val);
            } else {
                int notify = (val-&amp;gt;storage == REDIS_VM_LOADING);

                /* Our value was swapped on disk. Bring it at home. */
                redisAssert(val-&amp;gt;type == REDIS_VMPOINTER);
                val = vmLoadObject(val);
                dictGetEntryVal(de) = val;

                /* Clients blocked by the VM subsystem may be waiting for
                 * this key... */
                if (notify) handleClientsBlockedOnSwappedKey(db,key);
            }
        }
        server.stat_keyspace_hits++;
        return val;
    } else {
        server.stat_keyspace_misses++;
        return NULL;
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Redis uses its own hash table implementation to store keys and their values in
memory. Inside the &lt;code&gt;db&lt;/code&gt; object, the field &lt;code&gt;dict&lt;/code&gt; is a pointer to the hash
value for the current Redis database (remember there can be up to 16 separate
databases in a single Redis server instance, indexed by number).&lt;/p&gt;

&lt;p&gt;First, Redis calls &lt;code&gt;dictFind&lt;/code&gt; with the database&amp;#39;s hash table and a pointer
to the key&amp;#39;s bytestring. &lt;code&gt;dictFind&lt;/code&gt; looks up the hash of the key in the
table, using a standard algorithm that should be familiar to anyone who&amp;#39;s
implemented a hash table (check out &lt;code&gt;dict.c&lt;/code&gt; starting at line 391 if you&amp;#39;re
interested, the table is an array with linked lists for colliding hashes).&lt;/p&gt;

&lt;p&gt;If the key is found in the table, &lt;code&gt;dictFind&lt;/code&gt; returns a pointer to the entry in
the table. Otherwise, it returns &lt;code&gt;NULL&lt;/code&gt;. Back in &lt;code&gt;lookupKey&lt;/code&gt;, if the entry is
not null, Redis retrieves the value (i.e., the Redis object our key
references) from the hash table via &lt;code&gt;dictGetEntryVal&lt;/code&gt; and takes care of a bit
of bookkeeping for expiry and VM, if the key was found, and stats in either
case (hits and misses). If the entry was &lt;code&gt;NULL&lt;/code&gt;, then &lt;code&gt;lookupKey&lt;/code&gt; also returns
&lt;code&gt;NULL&lt;/code&gt;; we&amp;#39;ll see how this is handled by Redis for a reply to the client when
the key is not found, which is the case for us at this stage.&lt;/p&gt;

&lt;p&gt;With the value of &lt;code&gt;lookupKey&lt;/code&gt;, we&amp;#39;ll go back up the stack to our callers. Back
to &lt;code&gt;lookupKeyReadOrReply&lt;/code&gt;, we look at line 60:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# t_string.c:60
        if (!o) addReply(c,reply);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since we got &lt;code&gt;NULL&lt;/code&gt; from &lt;code&gt;lookupKey&lt;/code&gt; this time, we call &lt;code&gt;addReply&lt;/code&gt;.  The value
of &lt;code&gt;reply&lt;/code&gt; here comes from the call in &lt;code&gt;getGenericCommand&lt;/code&gt;, and it is
&lt;code&gt;shared.nullbulk&lt;/code&gt;. This field in the global struct object &lt;code&gt;shared&lt;/code&gt; is
initialize thusly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.c:712
shared.nullbulk = createObject(REDIS_STRING,sdsnew(&amp;quot;$-1\r\n&amp;quot;));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can see that it is a Redis string object who&amp;#39;s on-the-wire value is
&lt;code&gt;$-1\r\n&lt;/code&gt;, meaning a length of -1, Redis&amp;#39;s way of indicating null to a
client, according to the protocol.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;addReply&lt;/code&gt; builds the reply to the client. It does this by first setting up a
write event on the main event loop listener with &lt;code&gt;_installWriteEvent&lt;/code&gt;. This
makes sure that the reply is written out to the client connection when there
are bytes present in the buffer. Next, Redis adds the reply to the client&amp;#39;s
buffer. If the reply object were an non-string value like an integer, or a
list, or a set, Redis would first decode it to a bytestring that can be
serialized to, for example, on a socket. Redis string objects are encoded
&amp;quot;raw,&amp;quot; or as-is. The &lt;code&gt;nullbulk&lt;/code&gt; object is technically a string object, so no
decoding is necessary in our case. In any case, the reply bytestring is copied
to the client&amp;#39;s reply buffer with &lt;code&gt;_addReplyToBuffer&lt;/code&gt;, which for all intents
and purposes completes the execution of our &lt;code&gt;get&lt;/code&gt; command on the server.&lt;/p&gt;

&lt;p&gt;The client will read the on-the-wire reply of &lt;code&gt;$-1\r\n&lt;/code&gt; and know that it is a
string reply of length -1, and therefore is the null (or &amp;quot;nil,&amp;quot; in the context
of &lt;code&gt;redis-cli&lt;/code&gt;) object, and to convert that into the appropriate object for
the language of the client. Back to our &lt;code&gt;redis-cli&lt;/code&gt; client patiently waiting
for a reply from our breakpointed server, which we continue from, that looks
like:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(nil)
redis&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h1&gt;SET&lt;/h1&gt;

&lt;p&gt;The &lt;code&gt;set&lt;/code&gt; command proceeds much the same way as the &lt;code&gt;get&lt;/code&gt;, up to the point of
command dispatching on the server.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# client
redis&amp;gt; set users:1234 &amp;quot;Paul Smith&amp;quot;

# server
Breakpoint 1, readQueryFromClient (el=0x100400000, fd=6, privdata=0x100805e00, mask=1) at networking.c:801
801     void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask) {
(gdb) n
802         redisClient *c = (redisClient*) privdata;
(gdb) n
808         nread = read(fd, buf, REDIS_IOBUF_LEN);
(gdb) n
809         if (nread == -1) {
(gdb) print nread
$1 = 47
(gdb) x/47cb buf
0x7fff5fbfeba0: 42 &amp;#39;*&amp;#39;  51 &amp;#39;3&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 36 &amp;#39;$&amp;#39;  51 &amp;#39;3&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39;
0x7fff5fbfeba8: 115 &amp;#39;s&amp;#39; 101 &amp;#39;e&amp;#39; 116 &amp;#39;t&amp;#39; 13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 36 &amp;#39;$&amp;#39;  49 &amp;#39;1&amp;#39;  48 &amp;#39;0&amp;#39;
0x7fff5fbfebb0: 13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 117 &amp;#39;u&amp;#39; 115 &amp;#39;s&amp;#39; 101 &amp;#39;e&amp;#39; 114 &amp;#39;r&amp;#39; 115 &amp;#39;s&amp;#39; 58 &amp;#39;:&amp;#39;
0x7fff5fbfebb8: 49 &amp;#39;1&amp;#39;  50 &amp;#39;2&amp;#39;  51 &amp;#39;3&amp;#39;  52 &amp;#39;4&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 36 &amp;#39;$&amp;#39;  49 &amp;#39;1&amp;#39;
0x7fff5fbfebc0: 48 &amp;#39;0&amp;#39;  13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39; 80 &amp;#39;P&amp;#39;  97 &amp;#39;a&amp;#39;  117 &amp;#39;u&amp;#39; 108 &amp;#39;l&amp;#39; 32 &amp;#39; &amp;#39;
0x7fff5fbfebc8: 83 &amp;#39;S&amp;#39;  109 &amp;#39;m&amp;#39; 105 &amp;#39;i&amp;#39; 116 &amp;#39;t&amp;#39; 104 &amp;#39;h&amp;#39; 13 &amp;#39;\r&amp;#39; 10 &amp;#39;\n&amp;#39;
(gdb) print (char *)buf
$2 = 0x7fff5fbfeba0 &amp;quot;*3\r\n$3\r\nset\r\n$10\r\nusers:1234\r\n$10\r\nPaul Smith\r\n&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This time, our protocol-encoded bytestring is 47 bytes long, owing to the
extra argument &amp;quot;Paul Smith&amp;quot; and the length tag it requires. Also notice the
leading &lt;code&gt;*3&lt;/code&gt; indicates there are three arguments: &lt;code&gt;set&lt;/code&gt;, &lt;code&gt;users:1234&lt;/code&gt;, &lt;code&gt;Paul Smith&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Let&amp;#39;s skip ahead now to the point in &lt;code&gt;call&lt;/code&gt; in &lt;code&gt;redis.c&lt;/code&gt;, after the command has
been looked-up in the command table and the server is about ready to call the
underlying &lt;code&gt;proc&lt;/code&gt; function with the client object argument. The &lt;code&gt;set&lt;/code&gt; command,
in the form of a &lt;code&gt;redisCommand&lt;/code&gt; struct, looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# redis.c:73
{&amp;quot;set&amp;quot;,setCommand,3,REDIS_CMD_DENYOOM,NULL,0,0,0},
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that the arity of the command is 3, which includes the leading command
name, plus key and value, and matches what we expect from the client. The
&lt;code&gt;set&lt;/code&gt; command has a flag that &lt;code&gt;get&lt;/code&gt; did not: the constant &lt;code&gt;REDIS_CMD_DENYOOM&lt;/code&gt;
means that, in out-of-memory situations where Redis can&amp;#39;t allocate any more
memory, the execution of the command should be denied. (The absence of this
flag means that Redis can continue to serve client &amp;quot;read&amp;quot; requests like &lt;code&gt;get&lt;/code&gt;
even when the server can no longer write any new data.)&lt;/p&gt;

&lt;p&gt;I set a breakpoint on &lt;code&gt;setCommand&lt;/code&gt; and let the server continue running until
that point:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# server
(gdb) b setCommand
Breakpoint 2 at 0x10001a6e2: file t_string.c, line 48.
(gdb) c
Continuing.
Breakpoint 2, setCommand (c=0x100805e00) at t_string.c:48
48          c-&amp;gt;argv[2] = tryObjectEncoding(c-&amp;gt;argv[2]);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Incidentally, you can inspect the values of the client&amp;#39;s command arguments at
any time, with a simple &lt;code&gt;gdb&lt;/code&gt; invocation. The arguments are of type &lt;code&gt;robj&lt;/code&gt;,
which has a field &lt;code&gt;ptr&lt;/code&gt; that is a pointer to the actual value in memory. Since
in our &lt;code&gt;set&lt;/code&gt; case these are strings, we can inspect them by typecasting to
&lt;code&gt;char *&lt;/code&gt; like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) p (char *)c-&amp;gt;argv[0]-&amp;gt;ptr
$10 = 0x10032ae78 &amp;quot;set&amp;quot;
(gdb) p (char *)c-&amp;gt;argv[1]-&amp;gt;ptr
$11 = 0x10032b068 &amp;quot;users:1234&amp;quot;
(gdb) p (char *)c-&amp;gt;argv[2]-&amp;gt;ptr
$12 = 0x10032b098 &amp;quot;Paul Smith&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first thing the server does in &lt;code&gt;setCommand&lt;/code&gt; is encode the value being set
with &lt;code&gt;tryObjectEncoding&lt;/code&gt;. It will try to create an efficient encoding if the
bytestring can be interpreted as an integer, for example. This can save space
especially in the case where many numbers are being stored.  Additionally,
Redis will try to reuse shared integers as values instead of allocating
resources for new ones -- see the previous article for more on the creation
and use of shared integers.&lt;/p&gt;

&lt;p&gt;Once the value being set has been encoded, &lt;code&gt;setGenericCommand&lt;/code&gt; is called
(&lt;code&gt;set&lt;/code&gt; shares &lt;code&gt;setGenericCommand&lt;/code&gt; with the &lt;code&gt;setnx&lt;/code&gt; and &lt;code&gt;setex&lt;/code&gt; commands). From
here, &lt;code&gt;dbAdd&lt;/code&gt; is called, with the client, key, and value as arguments. &lt;code&gt;dbAdd&lt;/code&gt;
will only add the value to the database&amp;#39;s hash table if the key does not
already exist. In our case, since the key &lt;code&gt;users:1234&lt;/code&gt; does not exist, the
value of &lt;code&gt;dictFind&lt;/code&gt; is null, and the function proceeds to add the value with
&lt;code&gt;dictAdd&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;dictAdd&lt;/code&gt; takes the dictionary hash table, key, and value as arguments. It
uses &lt;code&gt;_dictKeyIndex&lt;/code&gt; to find the index of a free slot in the hash table for
our new entry. See the implementation in &lt;code&gt;dict.c&lt;/code&gt; and &lt;code&gt;dict.h&lt;/code&gt; for the details
of key hashing, and the structure of the dictionary and its component hash
tables (each Redis dictionary contains two hash tables in order to provide
incremental rehashing as the dictionary grows). &lt;code&gt;dictAdd&lt;/code&gt; allocates memory for
the new entry and stores it in the new index.&lt;/p&gt;

&lt;p&gt;The server returns back up the stack from &lt;code&gt;dictAdd&lt;/code&gt; and &lt;code&gt;dbAdd&lt;/code&gt; to
&lt;code&gt;setGenericCommand&lt;/code&gt;, where it increments the reference count on our new value.
Redis uses reference counting in order to free memory used by values that have
been deleted or have expired. It then &amp;quot;touches&amp;quot; the key so that if any clients
are &lt;code&gt;watch&lt;/code&gt;ing the key, the next &lt;code&gt;exec&lt;/code&gt; command will fail. It also increments
the server&amp;#39;s &lt;code&gt;dirty&lt;/code&gt; flag, which it uses to determine when to write out the
dump file to disk. Finally, it writes out the reply to the client, which is a
shared object, &lt;code&gt;shared.ok&lt;/code&gt;. This is special Redis string object in the
protocol that consists of the bytestring &amp;quot;+OK\r\n&amp;quot;. Clients will typically
convert this into the equivalent &amp;quot;true&amp;quot; value for their language.&lt;/p&gt;

&lt;h1&gt;GET redux&lt;/h1&gt;

&lt;p&gt;Our key is now set, so we can try the &lt;code&gt;get users:1234&lt;/code&gt; command again and see
how it differs for a found key.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# db.c:9
robj *lookupKey(redisDb *db, robj *key) {
    dictEntry *de = dictFind(db-&amp;gt;dict,key-&amp;gt;ptr);
    if (de) {
        robj *val = dictGetEntryVal(de);

        // ... skipping the lru &amp;amp; vm parts ... 

        server.stat_keyspace_hits++;
        return val;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The point where a &lt;code&gt;get&lt;/code&gt; on an existing key and a &lt;code&gt;get&lt;/code&gt; on a non-existent key
differ is line 11, where the &lt;code&gt;de&lt;/code&gt; entry in the database&amp;#39;s dictionary is found.
&lt;code&gt;dictGetEntryVal&lt;/code&gt; is a simple macro for accessing the field in the &lt;code&gt;de&lt;/code&gt; struct
that carries the value associated with the key. Redis updates its statistics
to indicate a key hit and returns the value object.&lt;/p&gt;

&lt;p&gt;Again, as with the key miss from above (remember the null value is a Redis
object, too), the value is decoded into the Redis bytestring protocol. This is
the response to the client, and we have concluded our &lt;code&gt;GET&lt;/code&gt;/&lt;code&gt;SET&lt;/code&gt;/&lt;code&gt;GET&lt;/code&gt; dance.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>The All-Blue-Collar League</title>
    <link href="/blog/2011/01/bluecollarleague.html" />
    <id>http://pauladamsmith.com/blog/2011/01/bluecollarleague.html</id>
    <updated>2011-01-24T00:22:00Z</updated>
    <content type="html">&lt;p&gt;In honor of the &lt;a href=&#34;http://sportsillustrated.cnn.com/football/nfl/gameflash/2011/01/23/4353_recap.html?&amp;amp;eref=sihp&#34;&gt;all&lt;/a&gt;-&lt;a href=&#34;http://sportsillustrated.cnn.com/football/nfl/gameflash/2011/01/23/4354_recap.html?eref=sihp&#34;&gt;union&lt;/a&gt; Super Bowl, I present the
All-Blue-Collar League, a collection of U.S. professional sports franchises
named after local unions, industry.&lt;/p&gt;

&lt;p&gt;In solidarity:&lt;/p&gt;

&lt;table id=&#34;teams&#34;&gt;
    &lt;tr&gt;
        &lt;th&gt;NFL&lt;/th&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team packers&#34; title=&#34;Named after the Indian Packing Company&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Green Bay &lt;b&gt;Packers&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team steelers&#34; title=&#34;Pittsburgh’s economy centered around the steel industry for many years.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Pittsburgh &lt;b&gt;Steelers&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team cowboys&#34; title=&#34;Texas cowboys were freelance livestock herders and handlers.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Dallas &lt;b&gt;Cowboys&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr&gt;
        &lt;th&gt;MLB&lt;/th&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team astros&#34; title=&#34;NASA’s Johnson Space Center and the greater space industry is a huge employer in the Houston region.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Houston &lt;b&gt;Astros&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team brewers&#34; title=&#34;Named for the city’s association with the beer brewing industry.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Milwaukee &lt;b&gt;Brewers&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team mariners&#34; title=&#34;The city’s location makes it a natural for many maritime industries, including fishmongering, and fishwivery.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Seattle &lt;b&gt;Mariners&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team rangers&#34; title=&#34;The Texas Rangers have been a statewide law enforcement agency since 1823, the oldest such agency in the U.S.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Texas &lt;b&gt;Rangers&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr&gt;
        &lt;th&gt;NBA&lt;/th&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team pistons&#34; title=&#34;Detroit is synonymous with the American auto industry, a source of high-quality middle-class jobs for most of the 20th century.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Detroit &lt;b&gt;Pistons&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr&gt;
        &lt;th&gt;NHL&lt;/th&gt;
    &lt;/tr&gt;
    &lt;tr class=&#34;team oilers&#34; title=&#34;Edmonton is one of Canada’s major oil refinery centers.&#34;&gt;
        &lt;td&gt;&lt;span&gt;&lt;/span&gt;Edmonton &lt;b&gt;Oilers&lt;/b&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;Thanks to &lt;a href=&#34;http://twitter.com/kostuch&#34;&gt;@kostuch&lt;/a&gt;, &lt;a href=&#34;http://twitter.com/ikesmith&#34;&gt;@ikesmith&lt;/a&gt;, &lt;a href=&#34;http://twitter.com/joshandrews&#34;&gt;@joshandrews&lt;/a&gt;, &lt;a href=&#34;http://twitter.com/tcarmody&#34;&gt;@tcarmody&lt;/a&gt;,
&lt;a href=&#34;http://twitter.com/lmsahistory&#34;&gt;@lmsahistory&lt;/a&gt;, and &lt;a href=&#34;http://twitter.com/janieporche&#34;&gt;@janieporche&lt;/a&gt; for suggestions.&lt;/p&gt;

&lt;style&gt;
#teams {
    width: 100%;
    margin-bottom: 1em;
}

#teams tr {
    clear: both;
}

#teams th {
    padding: 5px 6px;
}

#teams th {
    background: hsla(215, 35%, 35%, 1.0);
    color: white;
}

#teams td {
    height: 50px;
    line-height: 50px;
    padding: 5px 0;
    border-bottom: 1px solid hsla(215, 35%, 35%, 0.5);
}

#teams td span {
    display: block;
    float: left;
    height: 50px;
    width: 50px;
    margin-right: 10px;
    background-image: url(/images/blue_collar_sprite.png);
    background-repeat: no-repeat;
}

#teams .explanation {
    display: none;
}

.brewers td span { background-position: -50px 0px; }
.cowboys td span { background-position: -100px 0px; }
.mariners td span { background-position: -150px 0px; }
.oilers td span { background-position: -200px 0px; }
.packers td span { background-position: -250px 0px; }
.pistons td span { background-position: -300px 0px; }
.rangers td span { background-position: -350px 0px; }
.steelers td span { background-position: -400px 0px; }
&lt;/style&gt;
</content>
  </entry>
  <entry>
    <title>Gold is the same as paper</title>
    <link href="/blog/2011/01/gold.html" />
    <id>http://pauladamsmith.com/blog/2011/01/gold.html</id>
    <updated>2011-01-14T19:38:00Z</updated>
    <content type="html">&lt;div style=&#34;float: right; margin-left: 1em; padding: 5px&#34;&gt;&lt;a
href=&#34;http://www.flickr.com/photos/7159212@N05/442965594/&#34; title=&#34;photo by tao_zhyn on Flickr&#34;&gt;&lt;img
src=&#34;/images/gold.jpg&#34; width=&#34;240&#34; height=&#34;128&#34; alt=&#34;gold coins&#34;
class=&#34;facebook-image&#34;&gt;&lt;/a&gt;&lt;/div&gt;

&lt;p&gt;We won’t return to a gold standard because changing to a fiat currency was
one of the great innovations of modern economics. You aren’t literally
and figuratively weighed down by gold, and that allows central banks and
governments to set policy that allows them to rebound from crises, spur
growth, and lift people out of poverty and short lifespans. As &lt;a href=&#34;http://www.thenation.com/audio/157757/breakdown-should-us-return-gold-standard&#34; title=&#34;Episode of The Breakdown with Chris Hayes podcast by The Nation&#34;&gt;Liaquat
Ahamed points out&lt;/a&gt;, the gold standard is also a sure way to get yourself
in a deflationary cycle.&lt;/p&gt;

&lt;p&gt;But, wait! gold bugs will say. That paper isn’t worth the paper it’s
printed on. Gold has &lt;em&gt;real&lt;/em&gt; value, that’s why it was the world’s
currency for many years. The problem with this is that money is a
&lt;a href=&#34;http://en.wikipedia.org/wiki/Turtles_all_the_way_down&#34;&gt;turtles-all-the-way-down&lt;/a&gt; concept. Gold is just as much a pointer
to value as paper is, except it has many more downsides: it’s heavier,
more cumbersome to exchange, and has a fixed supply.&lt;/p&gt;

&lt;p&gt;Gold isn’t valuable in and of itself. You can’t live in gold. You can’t eat
gold. You can’t clothe yourself in gold. A gold coin can’t paint your house,
or build you a website. You could (hypothetically) use it to put your kids
through college, so it that sense it’s valuable to you, but &lt;em&gt;only in its
exchange&lt;/em&gt;, because on the other end, the trustees and professors and janitors
at the college need to live somewhere, eat something, wear something,
and have websites built. And again they exchange it for those goods and
services. So really the only thing that’s intrinsic to this little economy
I’ve just described is the fact that you, the college trustees, the service
providers, et al., all agree on the value or rate of exchange. It’s like
an algebraic equation where constants cancel out — gold is the constant,
so we can abstract it away. It may as well be “neighborhood fun bucks,”
so long as everyone agrees on the rate of exchange for goods and services.&lt;/p&gt;

&lt;p&gt;And there you have it. Economies have nothing to do with the particulars of
their currencies, and everything to do with people and institutions trusting
that, in exchange for some amount, I will receive something of perceived
equal value. Trust, and perception. Currencies are just a convenient
means by which we mitigate that exchange, an abstraction, a stand-in
for a hypothetical exchange, ultimately, an exchange built on trust.&lt;/p&gt;

&lt;p&gt;Interestingly, the only inherent value gold has is in its use as
jewelry. Which, aside from any aesthetic concerns, couldn’t be more
appropriate for our discussion, because people wear gold jewelry &lt;em&gt;as a
signifier of wealth&lt;/em&gt;. A pointer, a marker, an abstraction for the wealth
itself, which, again, is just the potential for exchange.&lt;/p&gt;

&lt;p&gt;It is this essential trust network at the core of economics that explains
why there is so much noise about gold. It reflects a lack of trust on the
part of gold advocates in our central banking and governmental institutions,
which they feel pursue policies that aren’t in their interest, or are in
the interest of undeserving populations. The switch to a gold standard,
therefore, has nothing to do with inflation or any other “economic”
concern, and everything to do with pursuing a political objective. The
market of exchange in this little political economy is for ideas about
reprioritizing our institutions. Which is a legitimate topic of national
debate. But reverting to the gold standard, as a practical economic matter,
would be bonkers.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Taking Go for a spin</title>
    <link href="/blog/2011/01/go.html" />
    <id>http://pauladamsmith.com/blog/2011/01/go.html</id>
    <updated>2011-01-12T12:00:00Z</updated>
    <content type="html">&lt;p&gt;I was struck by the high-level abstractions &lt;a href=&#34;http://golang.org/&#34;&gt;Go&lt;/a&gt;
provides for writing networked clients and servers, even by the standards of
conventionally high-level languages like Python. Given Go’s identification
as a systems programming language, this is initially surprising, because
such languages tend to be low-level for performance reasons (Go does
expose a lot of low-level interfaces through various packages like &lt;code&gt;os&lt;/code&gt;
and &lt;code&gt;syscall&lt;/code&gt;), but of course there would be good support for these
things because Go is a modern language designed by folks with many years
of experience writing networked servers.&lt;/p&gt;

&lt;p&gt;Specifically, the &lt;code&gt;net&lt;/code&gt; package provides the &lt;code&gt;Listener&lt;/code&gt; and &lt;code&gt;Conn&lt;/code&gt; types
that hide many of the details of setting up socket connections. A simple
&lt;code&gt;net.Listen(&amp;quot;tcp&amp;quot;, &amp;quot;:1234&amp;quot;)&lt;/code&gt; is enough to get the equivalent of a listener,
or server, socket. The &lt;code&gt;bufio&lt;/code&gt; package provides buffered read methods,
simplifying common tasks like reading lines from a socket.&lt;/p&gt;

&lt;p&gt;Let’s dive in and take a look at one way to implement a classic echo
server. I tried to use Go’s language features for concurrent communication,
goroutines and channels, at crucial points. Where a different implementation
in different language might fork a new process or spawn a new thread to
handle a new client connection, a goroutine was started and the details
of the connection communicated with a channel.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;go&#34;&gt;package main

import (
    &amp;quot;net&amp;quot;
    &amp;quot;bufio&amp;quot;
    &amp;quot;strconv&amp;quot;
    &amp;quot;fmt&amp;quot;
)

const PORT = 3540
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All Go programs must have a &lt;code&gt;package main&lt;/code&gt;. We declare a number of packages to
be imported, &lt;code&gt;net&lt;/code&gt; and &lt;code&gt;bufio&lt;/code&gt; already mentioned, &lt;code&gt;strconv&lt;/code&gt; for its conversion
function &lt;code&gt;Itoa()&lt;/code&gt; that converts an integer to a string, and &lt;code&gt;fmt&lt;/code&gt; for printing
strings to the console. Our echo server will listen on port 3540.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;go&#34;&gt;func main() {
    server, err := net.Listen(&amp;quot;tcp&amp;quot;, &amp;quot;:&amp;quot; + strconv.Itoa(PORT))
    if server == nil {
        panic(&amp;quot;couldn&amp;#39;t start listening: &amp;quot; + err.String())
    }
    conns := clientConns(server)
    for {
        go handleConn(&amp;lt;-conns)
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Every Go program must have a function &lt;code&gt;main()&lt;/code&gt; in its &lt;code&gt;package main&lt;/code&gt;. We start
by declaring and initializing a new listener for our echo server. We choose
the more generic &lt;code&gt;net.Listen()&lt;/code&gt; over &lt;code&gt;net.TCPListen()&lt;/code&gt;, because we can
conveniently parameterize the type of the listener with a string to the first
argument of &lt;code&gt;Listen&lt;/code&gt;. (It is generally preferred in Go to deal with the most
generic type, or interface, especially when writing function and method
signatures, and either allow a specific type to be inferred by the compiler or
specify it when declaring/initializing a variable.) &lt;code&gt;&amp;quot;:&amp;quot; + strconv.Itoa(PORT)&lt;/code&gt;
is a string concentation expression, and the port constant we defined earlier
is converted to a string. (Strictly, a numeric constant is not an integer of a
particular type, but the string conversion function works here because the
compiler converts the constant into the concrete type to match the function
signature.)&lt;/p&gt;

&lt;p&gt;The idiom for Go when handling multiple return values where the last has an
error type is to check the main object for nil, and then &lt;code&gt;panic()&lt;/code&gt; with the
stringified error object. This is generally preferred over printing to stderr
and using &lt;code&gt;os.Exit()&lt;/code&gt;, because it gives callers higher up the stack the chance
to &lt;code&gt;recover()&lt;/code&gt;, sort of a raise/catch exception flow.&lt;/p&gt;

&lt;p&gt;Using Go’s compact syntax for simultaneous declaration and initialization, we
set &lt;code&gt;conns&lt;/code&gt; to the value of the function call &lt;code&gt;clientConns(server)&lt;/code&gt;. This is
the channel we’ll use for getting new client connections.&lt;/p&gt;

&lt;p&gt;The equivalent of a infinite loop like &lt;code&gt;while True:&lt;/code&gt; or &lt;code&gt;for (;;)&lt;/code&gt; in Go is
&lt;code&gt;for { ... }&lt;/code&gt;. Each time through the loop, we start a goroutine, calling
&lt;code&gt;handleConn()&lt;/code&gt; with the value of the receive operation on our client connections
channel. The unary receive operator &lt;code&gt;&amp;lt;-&lt;/code&gt; blocks until a value is available on
the channel, in our case, a new client having connected.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;go&#34;&gt;func clientConns(listener net.Listener) chan net.Conn {
    ch := make(chan net.Conn)
    i := 0
    go func() {
        for {
            client, err := listener.Accept()
            if client == nil {
                fmt.Printf(&amp;quot;couldn&amp;#39;t accept: &amp;quot; + err.String())
                continue
            }
            i++
            fmt.Printf(&amp;quot;%d: %v &amp;lt;-&amp;gt; %v\n&amp;quot;, i, client.LocalAddr(),
                client.RemoteAddr())
            ch &amp;lt;- client
        }
    }()
    return ch
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We create a new channel of type &lt;code&gt;net.Conn&lt;/code&gt;, which corresponds to the type that
we’ll get from calling &lt;code&gt;Accept()&lt;/code&gt; on our listener connection object. We start
off a new, anonymous goroutine which runs in an infinite loop, constantly
accepting new connections. &lt;code&gt;listener.Accept()&lt;/code&gt; blocks as long as there are no
new clients to deal with, but since we’re running inside a goroutine and
&amp;quot;detached&amp;quot; from the main program flow, other already-connected clients can
continue to be handled without interruption (this is where a &lt;code&gt;fork()&lt;/code&gt; or a new
thread would happen in a typical server). Instead of &lt;code&gt;panic()&lt;/code&gt;ing here if
there is an error connecting with the client, we simply note it on the console
of the server and move on. We also keep track of the number of clients we’ve
seen with the counter &lt;code&gt;i&lt;/code&gt;. &lt;code&gt;fmt.Printf()&lt;/code&gt; works like you’d expect, though the
&lt;code&gt;%v&lt;/code&gt; format is not like anything in C’s &lt;code&gt;printf()&lt;/code&gt; — it prints a value in a
default format and works for any type, somewhat like &lt;code&gt;repr()&lt;/code&gt; in Python.&lt;/p&gt;

&lt;p&gt;The binary &lt;code&gt;&amp;lt;-&lt;/code&gt; communication operator is used to send the client, of type
&lt;code&gt;net.Conn&lt;/code&gt; to the channel we created at the top. Go has lexical scope (and is
garbage-collected), so &lt;code&gt;ch&lt;/code&gt; is available inside the anonymous goroutine and
after our function returns (because the infinite &lt;code&gt;Accept()&lt;/code&gt;ing for-loop keeps
the goroutine alive).&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;go&#34;&gt;func handleConn(client net.Conn) {
    b := bufio.NewReader(client)
    for {
        line, err := b.ReadBytes(&amp;#39;\n&amp;#39;)
        if err != nil { // EOF, or worse
            break
        }
        client.Write(line)
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As we saw back in &lt;code&gt;main()&lt;/code&gt;, &lt;code&gt;handleConn()&lt;/code&gt; is invoked as a goroutine with each
new client connection (the connection being received from the other side of
the channel we just created). &lt;code&gt;bufio.NewReader()&lt;/code&gt; wraps the client object with
a nicer interface for reading lines of bytes from. If we decided to use the
&lt;code&gt;Read()&lt;/code&gt; method of the &lt;code&gt;net.Conn&lt;/code&gt; object, our code would be more complex,
having to check for the substring &lt;code&gt;&amp;quot;\n&amp;quot;&lt;/code&gt; and testing for EOF. Instead, we can
treat this as a line-oriented protocol, and simply get a line and write it
back to the client, as long as there are lines to be read.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gist.github.com/775764&#34;&gt;Here’s the whole thing&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The pattern of getting new connections from a channel and starting a goroutine
to handle them is conceptually clean, and also happens to be a straightforward
way to write a multiplexing, concurrent server.&lt;/p&gt;
</content>
  </entry>
  </feed>